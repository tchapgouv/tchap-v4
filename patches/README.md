## How to make patches

-   Make some changes to dependencies files (matrix-react-sdk or matrix-js-sdk) : in node_modules/matrix-react-sdk, or in the yarn-linked repo if you are using yarn links.
-   add the info for your new patch `my-new-patch-name` in `patches/patches.json`
-   run `yarn patch-make my-new-patch-name`

Wwhen you have made edits to the files, recreate the patch by running again : `yarn patch-make my-new-patch-name`

Note : if you are making a patch while your local env has yarn links, patch-package will take longer time to run "Diffing your files with clean files". But it does work.

## Merge patches when upgrading element.

First run the merge command, it takes long if you have multiple patches

```
bash ./scripts/merge-patches.sh merge
```

If some patches are in conflict, a folder is created in patches_temp/

To see the conflicted files run :

```
bash ./scripts/merge-patches.sh continue <absolute_path>/tchap-web-v4/patches_temp/PATCH_NAME
```

Fix the conlicts inside the <absolute_path>/tchap-web-v4/patches_temp/PATCH_NAME/node_modules/....

After the conflict is solved, run again
bash ./scripts/merge-patches.sh continue <absolute_path>/tchap-web-v4/patches_temp/PATCH_NAME

A notice should be in the log that a new patch has been created in folder : absolute_path>/tchap-web-v4/patches/

Compare the old patch and the new patch, if it looks ok to you then delete manually the old patch

NB : merge command can be used with only one patch also

```
bash ./scripts/merge-patches.sh merge <absolute_path>/tchap-web-v4/patches/PATCH_NAME/PATCH_FILE.patch
```

## How to deal with patch conflicts

Patch files are generated by machines, and should not be edited by humans, it will cause errors.

Humans confronted with a conflict between two versions of a patch file should solve the conflict by hand in the code files, and then regenerate the patch file.

Imagine you have a conflict in file Conflict.tsx, which causes a conflict in the corresponding patch file.

Conflict.tsx is in node_modules/matrix-react-sdk, so it is gitignored, so the conflict appears in git only on the patch file.

You have this situation : (timeline is read from bottom to top)

```
* merge conflict between develop_tchap and my-feature-branch !
|\
* | merge of other-feature-branch into develop_tchap
| * commits implementing work on my-feature-branch
|/
* develop_tchap code
```

What you can do : (timeline is read from bottom to top)

```
* merge my-feature-branch into develop_tchap : no more confict !
|\
| * merge tmp-branch and my-feature-branch : solve Conflicted.tsx by hand, then regenerate patch file
| |\
| * | make tmp-branch from develop_tchap, commit develop_tchap's version of Conflicted.tsx
|/ /
| * commit my-feature-branch's version of Conflicted.tsx
* | merge of other-feature-branch into develop_tchap
| * commits implementing work on my-feature-branch
|/
* develop_tchap code
```

When you check out a branch, watch out that since Conflicted.tsx is gitignored, the changes are not applied to it. Conflict.tsx's version is still the one of the previous branch you were at.

To get the version of Conflicted.tsx corresponding to the branch you just checked out, you can recreate it cleanly :

```
yarn patches-reapply
```
